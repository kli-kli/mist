#!/usr/bin/env bash

name=""
context=""
config=""
java_args=""
jar=""

while [[ $# > 1 ]]
do
  key="$1"
  case ${key} in
    --name)
      name="$2"
      shift
      ;;

    --context)
      context="$2"
      shift
      ;;

    --config)
      config="$2"
      shift
      ;;

    --jar)
      jar="$2"
      shift
      ;;
    
    --run-options)
      run_options="$2"
      shift
      ;;

    --java-args)
      java_args="$2"
      shift
      ;;

  esac
shift
done

if [ "${name}" == '' ]
then
    (>&2 echo "You must specify --name")
    exit 3
fi

if [ "${context}" == '' ]
then
    (>&2 echo "You must specify --context")
    exit 3
fi

if [ "${config}" == '' ]
then
    (>&2 echo "You must specify --config")
    exit 3
fi

if [ "${jar}" == '' ]
then
    (>&2 echo "You must specify --jar_file")
    exit 3
fi

if [ "${SPARK_HOME}" == '' ]
then
    (>&2 echo "You must specify SPARK_HOME env variable")
    exit 3
fi

export PYTHONPATH="$SPARK_HOME/python:`readlink -f ${SPARK_HOME}/python/lib/py4j*`:$PYTHONPATH"

SPARK_SUBMIT="${SPARK_HOME}/bin/spark-submit"
MAIN_CLASS="io.hydrosphere.mist.worker.Worker"
DRIVER_JAVA_OPTIONS="-Dconfig.file=${config} -Dakka.roles.1=worker-${name} ${java_args}"

exec $SPARK_SUBMIT --class $MAIN_CLASS --driver-java-options "$DRIVER_JAVA_OPTIONS" ${run_options} $jar $name $context
